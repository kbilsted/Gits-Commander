using GitsCommander.Infrastructure;

namespace GitsCommander.RepoListAggregate;

record RepoListCommandHandler(WorkItemEngine engine, RepositoriesLogic fetcher, IMediator Mediator)
    : INotificationHandler<RepoListWasCreated>,
    INotificationHandler<GetRepoListCommand>
{

    public async Task Handle(GetRepoListCommand notification, CancellationToken cancellationToken)
    {
        List<Repository> repos;

        if (InMemoryDatabase.LocalRun)
        {
            string json = @"[{""Id"":2,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":"".NetDllApiDump"",""Url"":""https://github.com/kbilsted/.NetDllApiDump.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":3,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""1FileParsers"",""Url"":""https://github.com/kbilsted/1FileParsers.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":4,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""AllgetDependencyManager"",""Url"":""https://github.com/kbilsted/AllgetDependencyManager.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":5,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""angular-search"",""Url"":""https://github.com/kbilsted/angular-search.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":6,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""ApprovalTests.Net"",""Url"":""https://github.com/kbilsted/ApprovalTests.Net.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":7,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""AsciiUml"",""Url"":""https://github.com/kbilsted/AsciiUml.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":8,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""AutoHasher"",""Url"":""https://github.com/kbilsted/AutoHasher.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":9,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""AutonumberMarkdown"",""Url"":""https://github.com/kbilsted/AutonumberMarkdown.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":10,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""BlogBuilder"",""Url"":""https://github.com/kbilsted/BlogBuilder.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":11,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""C-sharp-console-gui-framework"",""Url"":""https://github.com/kbilsted/C-sharp-console-gui-framework.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":12,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""CodeQualityAndReadability"",""Url"":""https://github.com/kbilsted/CodeQualityAndReadability.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":13,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""CommandLineUtils"",""Url"":""https://github.com/kbilsted/CommandLineUtils.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":14,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""CommodoreBasicReformatter"",""Url"":""https://github.com/kbilsted/CommodoreBasicReformatter.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":15,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""CompilerTeknik"",""Url"":""https://github.com/kbilsted/CompilerTeknik.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":16,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""coveralls.net"",""Url"":""https://github.com/kbilsted/coveralls.net.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":17,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""CSharp_BinarySerialization"",""Url"":""https://github.com/kbilsted/CSharp_BinarySerialization.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":18,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""dotnet-tools"",""Url"":""https://github.com/kbilsted/dotnet-tools.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":19,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""EFCoreEagerFetching"",""Url"":""https://github.com/kbilsted/EFCoreEagerFetching.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":20,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""FastColoredTextBox"",""Url"":""https://github.com/kbilsted/FastColoredTextBox.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":21,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""FrameworkDependencyFinder"",""Url"":""https://github.com/kbilsted/FrameworkDependencyFinder.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":22,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""FSharpFriendlyDotNet"",""Url"":""https://github.com/FSharpFriends/FSharpFriendlyDotNet.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":23,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""Functional-core-imperative-shell"",""Url"":""https://github.com/kbilsted/Functional-core-imperative-shell.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":24,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""gitextensions"",""Url"":""https://github.com/kbilsted/gitextensions.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":25,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""github-release-history"",""Url"":""https://github.com/kbilsted/github-release-history.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":26,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""GitHubServices"",""Url"":""https://github.com/kbilsted/GitHubServices.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":27,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""gui.cs"",""Url"":""https://github.com/kbilsted/gui.cs.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":28,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""KBGit"",""Url"":""https://github.com/kbilsted/KBGit.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":29,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""KeyboordUsage"",""Url"":""https://github.com/kbilsted/KeyboordUsage.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":30,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""LineCounter.Net"",""Url"":""https://github.com/kbilsted/LineCounter.Net.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":31,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""MassTransit"",""Url"":""https://github.com/kbilsted/MassTransit.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":32,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""MSBuild.AutoILMerge.Task"",""Url"":""https://github.com/kbilsted/MSBuild.AutoILMerge.Task.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":33,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""NotepadPlusPlusPluginPack.Net"",""Url"":""https://github.com/kbilsted/NotepadPlusPlusPluginPack.Net.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":34,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""NppPluginCutNCopyLine"",""Url"":""https://github.com/kbilsted/NppPluginCutNCopyLine.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":35,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""NppPluginGuidHelper"",""Url"":""https://github.com/kbilsted/NppPluginGuidHelper.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":36,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""NppPluginMarkDownAssister"",""Url"":""https://github.com/kbilsted/NppPluginMarkDownAssister.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":37,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""NppPluginRebaseAssister"",""Url"":""https://github.com/kbilsted/NppPluginRebaseAssister.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":38,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""nullpomino"",""Url"":""https://github.com/kbilsted/nullpomino.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":39,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""Okanshi"",""Url"":""https://github.com/kbilsted/Okanshi.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":40,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""ReassureTest.Net"",""Url"":""https://github.com/kbilsted/ReassureTest.Net.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":41,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""ReinforcementLearnings"",""Url"":""https://github.com/kbilsted/ReinforcementLearnings.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":42,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""SmtpServerDemo"",""Url"":""https://github.com/kbilsted/SmtpServerDemo.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":43,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""StatePrinter"",""Url"":""https://github.com/kbilsted/StatePrinter.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":44,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""StatePrinter.Java"",""Url"":""https://github.com/kbilsted/StatePrinter.Java.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":45,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""super-csv"",""Url"":""https://github.com/kbilsted/super-csv.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":46,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""TempleOS"",""Url"":""https://github.com/kbilsted/TempleOS.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":47,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""Type-ahead-search"",""Url"":""https://github.com/kbilsted/Type-ahead-search.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":48,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""up-for-grabs.net"",""Url"":""https://github.com/kbilsted/up-for-grabs.net.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":49,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""VirtMatty"",""Url"":""https://github.com/kbilsted/VirtMatty.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":50,""NamePrefix"":""Github/kbilsted"",""VirtualPath"":"""",""Name"":""WhitespaceWarrior"",""Url"":""https://github.com/kbilsted/WhitespaceWarrior.git"",""DestinationPath"":""c:\\temp\\try""},{""Id"":0,""NamePrefix"":""Gitlab"",""VirtualPath"":""acmegroup2"",""Name"":""Acme under water Welding"",""Url"":""https://gitlab.com/acmegroup2/acme-under-water-welding.git"",""DestinationPath"":""c:\\temp\\flopacmegroup2""},{""Id"":1,""NamePrefix"":""Gitlab"",""VirtualPath"":""acmegroup2/subtractors-code"",""Name"":""Mumbai adventures"",""Url"":""https://gitlab.com/acmegroup2/subtractors-code/mumbai-adventures.git"",""DestinationPath"":""c:\\temp\\flopacmegroup2/subtractors-code""}]";
            repos = JsonSerializer.Deserialize<List<Repository>>(json)!;
        }
        else
        {
            repos = (await fetcher.GetRepositories())
                .OrderBy(x => x.NamePrefix)
                .ThenBy(x => x.VirtualPath)
                .ThenBy(x => x.Name)
                .ToList();
        }

        await Mediator.Publish(new RepoListWasCreated(repos));
    }

    public Task Handle(RepoListWasCreated notification, CancellationToken cancellationToken)
    {
        Task.Run(() => engine.PullOrCloneItems(notification.Repos));
        return Task.CompletedTask;
    }
}
